<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPORTES GMT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,wght@1,900&display=swap');
        body { font-family: 'Inter', sans-serif; font-style: italic; background-color: #f1f5f9; user-select: none; }
        .grid-card { border-radius: 1.5rem; background: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #001935; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; padding-right: 2rem !important; }
    </style>
</head>
<body class="pb-10">

    <div id="loginOverlay">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-black text-[#001935] mb-8 italic uppercase tracking-tighter">REPORTES <span class="text-[#019DF4]">GMT</span></h2>
            <input type="text" id="userInput" placeholder="Usuario" class="w-full p-4 mb-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-[#019DF4] font-bold italic text-sm">
            <input type="password" id="passInput" placeholder="Contraseña" class="w-full p-4 mb-8 bg-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-[#019DF4] font-bold italic text-sm">
            <button onclick="validarAcceso()" class="w-full bg-[#001935] text-white p-4 rounded-2xl font-black hover:bg-[#019DF4] transition-all uppercase italic tracking-widest">Entrar</button>
            <p id="loginError" class="text-red-500 text-[10px] mt-4 font-black hidden uppercase">Acceso Denegado</p>
        </div>
    </div>

    <nav class="bg-[#001935] p-4 border-b-4 border-[#019DF4] sticky top-0 z-50">
        <div class="max-w-[1800px] mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black text-white uppercase italic tracking-tighter">REPORTES <span class="text-[#019DF4]">GMT</span></h1>
            <div class="flex items-center gap-3">
                <select id="mSel" class="p-2 px-4 rounded-xl font-black text-[10px] outline-none border-none bg-white text-[#001935] uppercase"></select>
                <select id="wSel" class="p-2 px-4 rounded-xl font-black text-[10px] outline-none border-none bg-white text-[#001935] uppercase"></select>
                
                <label class="cursor-pointer bg-white/10 hover:bg-[#019DF4] p-2 px-4 rounded-xl transition-all group">
                    <span class="text-white text-[10px] font-black uppercase italic">Actualizar Local</span>
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                </label>
                
                <button onclick="logout()" class="p-2 px-4 bg-red-600 text-white rounded-xl text-[10px] font-black transition-all hover:bg-red-700 uppercase italic">Salir</button>
            </div>
        </div>
    </nav>

    <div id="mainContent" class="max-w-[1800px] mx-auto p-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="grid-card p-6 text-center border-b-4 border-[#019DF4]"><p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Nota Pospago</p><p id="k-pos" class="text-4xl font-black text-[#001935]">0%</p></div>
            <div class="grid-card p-6 text-center border-b-4 border-cyan-400"><p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Nota Prepago</p><p id="k-pre" class="text-4xl font-black text-[#001935]">0%</p></div>
            <div class="grid-card p-6 text-center border-b-4 border-slate-800"><p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Nota Total</p><p id="k-tot" class="text-4xl font-black text-[#001935]">0%</p></div>
            <div class="grid-card p-6 text-center border-b-4 border-blue-600"><p class="text-[10px] font-black text-gray-400 uppercase mb-1 italic">Monitoreos</p><p id="k-cas" class="text-4xl font-black text-[#001935]">0</p></div>
            <div class="grid-card p-6 text-center border-b-4 border-red-600"><p class="text-[10px] font-black text-red-600 uppercase mb-1 italic tracking-widest text-xs">Críticos</p><p id="k-cri" class="text-4xl font-black text-red-600">0</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="grid-card p-8 h-[450px] flex flex-col items-center"><canvas id="chPie"></canvas></div>
            <div class="grid-card p-8 h-[450px]"><canvas id="chAna"></canvas></div>
        </div>

        <div id="tablesContainer" class="space-y-10"></div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        const USER_OK = "admin", PASS_OK = "movi2026";
        const CSV_URL = "https://raw.githubusercontent.com/vamp00001/Reporte-QA-GMT-Movistar/main/movi_2.csv";
        
        let gData = []; let charts = {};
        const catNames = ["Apertura","Profesionalismo","Tono","Lenguaje","Contactación","Habilidades","Resolución","Empatía","Apreciación","Información","Procedimientos","Sistemas","Cierre"];

        function validarAcceso() {
            if(document.getElementById('userInput').value === USER_OK && document.getElementById('passInput').value === PASS_OK) {
                document.getElementById('loginOverlay').classList.add('hidden');
                cargarDesdeGitHub();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function cargarDesdeGitHub() {
            fetch(CSV_URL).then(r => r.text()).then(d => procesar(d)).catch(() => alert("Error al cargar base de datos de GitHub."));
        }

        document.getElementById('csvFileInput').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => procesar(ev.target.result);
            reader.readAsText(e.target.files[0], 'ISO-8859-1');
        });

        function procesar(csvText) {
            const lines = csvText.split(/\r?\n/).filter(l => l.includes(','));
            gData = lines.slice(1).map(line => {
                const p = line.split(',').map(c => c.trim().replace(/"/g, ''));
                let errs = [];
                for(let i=6; i<=18; i++) {
                    let v = (p[i] || "").toUpperCase();
                    errs.push(v.includes('ERROR') || v.includes('CRITICO') ? 1 : 0);
                }
                return {
                    mes: p[0], nota: parseFloat(p[1]) || 0, eje: p[2], sup: p[3], 
                    camp: p[4], sem: p[5], crit: errs.some(v => v === 1) ? 1 : 0, errs, ana: p[19] || "S/A"
                };
            });
            setup(); update('ALL', 'ALL');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        function setup() {
            const m = [...new Set(gData.map(d => d.mes))].sort();
            const w = [...new Set(gData.map(d => d.sem))].sort();
            const ms = document.getElementById('mSel'), ws = document.getElementById('wSel');
            ms.innerHTML = '<option value="ALL">MES ACUMULADO</option>';
            ws.innerHTML = '<option value="ALL">SEMANA</option>';
            m.forEach(x => ms.innerHTML += `<option value="${x}">${x}</option>`);
            w.forEach(x => ws.innerHTML += `<option value="${x}">${x}</option>`);
            ms.onchange = ws.onchange = () => update(ms.value, ws.value);
        }

        function update(fM, fW) {
            let d = gData;
            if(fM!=='ALL') d = d.filter(x => x.mes === fM);
            if(fW!=='ALL') d = d.filter(x => x.sem === fW);
            const pos = d.filter(x => x.camp.toUpperCase().includes('POSPAGO')), pre = d.filter(x => x.camp.toUpperCase().includes('PREPAGO'));
            const avg = (a) => a.length ? (a.reduce((s,v)=>s+v.nota,0)/a.length).toFixed(1) : 0;
            
            document.getElementById('k-pos').innerText = avg(pos) + "%";
            document.getElementById('k-pre').innerText = avg(pre) + "%";
            document.getElementById('k-tot').innerText = avg(d) + "%";
            document.getElementById('k-cas').innerText = d.length;
            document.getElementById('k-cri').innerText = d.reduce((s,v)=>s+v.crit,0);

            renderPie('chPie', {'POSPAGO': avg(pos), 'PREPAGO': avg(pre)});
            const anas = {}; d.forEach(x => anas[x.ana] = (anas[x.ana] || 0) + 1);
            renderBar('chAna', anas, '#019DF4'); 

            const container = document.getElementById('tablesContainer'); container.innerHTML = '';
            [...new Set(d.map(x => x.camp))].forEach(camp => {
                const dataCamp = d.filter(x => x.camp === camp);
                let html = `<div class="grid-card overflow-hidden shadow-xl"><div class="bg-[#001935] p-5 border-l-[12px] border-[#019DF4]"><h2 class="text-white font-black uppercase italic text-sm tracking-widest">${camp}</h2></div><table class="w-full text-[11px] text-left"><thead class="bg-gray-50 border-b italic font-black text-gray-400 uppercase"><tr><th class="p-4">Supervisor</th><th class="p-4">Ejecutivo</th><th class="p-4 text-center">Nota</th><th class="p-4 text-center">Estado</th></tr></thead><tbody class="divide-y divide-gray-100">`;
                
                // Agrupar por ejecutivo para la tabla
                const ag = dataCamp.reduce((acc, curr) => {
                    if (!acc[curr.eje]) acc[curr.eje] = { ...curr, notas: [curr.nota], totalCrit: curr.crit };
                    else { acc[curr.eje].notas.push(curr.nota); acc[curr.eje].totalCrit += curr.crit; }
                    return acc;
                }, {});

                Object.values(ag).forEach(x => {
                    const prom = (x.notas.reduce((s,v)=>s+v,0)/x.notas.length).toFixed(1);
                    html += `<tr><td class="p-4 font-bold text-gray-500">${x.sup}</td><td class="p-4 font-black text-[#001935] uppercase">${x.eje}</td><td class="p-4 text-center font-black text-lg">${prom}%</td><td class="p-4 text-center"><span class="px-3 py-1 rounded-full font-black ${x.totalCrit > 0?'bg-red-100 text-red-600':'bg-green-100 text-green-600'}">${x.totalCrit > 0?'CRITICO':'OK'}</span></td></tr>`;
                });
                container.innerHTML += html + `</tbody></table></div>`;
            });
        }

        function renderPie(id, m) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'pie', data: { labels: Object.keys(m), datasets: [{data: Object.values(m), backgroundColor: ['#001935','#019DF4'], borderWidth: 5, borderColor: '#fff'}]},
                options: { maintainAspectRatio: false, plugins: { datalabels: { color: '#fff', font: { weight: 'black', size: 16, style: 'italic' }, formatter: v => v + "%" }, legend: { position: 'top', labels: { font: { weight: 'bold', family: 'Inter'} } } } }
            });
        }

        function renderBar(id, m, c) {
            if(charts[id]) charts[id].destroy();
            const keys = Object.keys(m).sort((a,b)=>m[b]-m[a]).slice(0, 10);
            charts[id] = new Chart(document.getElementById(id), {
                type: 'bar', data: { labels: keys, datasets: [{data: keys.map(k=>m[k]), backgroundColor: c, borderRadius: 10}]},
                options: { maintainAspectRatio: false, plugins: { legend: {display:false}, datalabels: { anchor:'end', align:'top', font:{weight:'bold'} } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { weight: 'bold' } } } } }
            });
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>
