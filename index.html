<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANÁLISIS QA GMT MOVISTAR</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,wght@1,900&display=swap');
        body { font-family: 'Inter', sans-serif; font-style: italic; background-color: #f1f5f9; user-select: none; }
        .grid-card { border-radius: 1.5rem; background: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transition: transform 0.2s; }
        .grid-card:hover { transform: translateY(-2px); }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #001935; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; padding-right: 2.5rem !important; }
    </style>
</head>
<body class="pb-10">

    <div id="loginOverlay">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-black text-[#001935] mb-8 italic uppercase tracking-tighter">PLATAFORMA <span class="text-[#019DF4]">GMT</span></h2>
            <input type="text" id="userInput" placeholder="Usuario" class="w-full p-4 mb-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-[#019DF4] font-bold italic text-sm">
            <input type="password" id="passInput" placeholder="Contraseña" class="w-full p-4 mb-8 bg-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-[#019DF4] font-bold italic text-sm">
            <button onclick="validarAcceso()" class="w-full bg-[#001935] text-white p-4 rounded-2xl font-black hover:bg-[#019DF4] transition-all uppercase italic tracking-widest">Entrar</button>
            <p id="loginError" class="text-red-500 text-[10px] mt-4 font-black hidden uppercase">Acceso Denegado</p>
        </div>
    </div>

    <nav class="bg-[#001935] p-6 border-b-4 border-[#019DF4] sticky top-0 z-50">
        <div class="max-w-[1800px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-2xl font-black text-white uppercase italic tracking-tighter">ANÁLISIS QA <span class="text-[#019DF4]">GMT MOVISTAR</span></h1>
            <div class="flex flex-wrap gap-2">
                <select id="mSel" class="p-2 px-4 rounded-xl font-black text-[10px] outline-none border-none bg-white text-[#001935] uppercase"></select>
                <select id="wSel" class="p-2 px-4 rounded-xl font-black text-[10px] outline-none border-none bg-white text-[#001935] uppercase"></select>
                <button onclick="logout()" class="p-2 px-6 bg-red-600 text-white rounded-xl text-[10px] font-black transition-all hover:bg-red-700 uppercase italic">Salir</button>
            </div>
        </div>
    </nav>

    <div id="mainContent" class="max-w-[1800px] mx-auto p-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="grid-card p-6 border-t-4 border-[#019DF4] text-center"><p class="text-[10px] font-black text-gray-400 uppercase mb-1">Nota Pospago</p><p id="k-pos" class="text-4xl font-black text-[#001935]">0%</p></div>
            <div class="grid-card p-6 border-t-4 border-cyan-400 text-center"><p class="text-[10px] font-black text-gray-400 uppercase mb-1">Nota Prepago</p><p id="k-pre" class="text-4xl font-black text-[#001935]">0%</p></div>
            <div class="grid-card p-6 border-t-4 border-slate-800 text-center"><p class="text-[10px] font-black text-gray-400 uppercase mb-1">Nota Total</p><p id="k-tot" class="text-4xl font-black text-[#001935]">0%</p></div>
            <div class="grid-card p-6 border-t-4 border-blue-600 text-center"><p class="text-[10px] font-black text-gray-400 uppercase mb-1">Monitoreos</p><p id="k-cas" class="text-4xl font-black text-[#001935]">0</p></div>
            <div class="grid-card p-6 border-t-4 border-red-600 text-center"><p class="text-[10px] font-black text-red-600 uppercase mb-1">Críticos</p><p id="k-cri" class="text-4xl font-black text-red-600">0</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="grid-card p-8 h-[450px] flex flex-col items-center"><h3 class="text-[11px] font-black uppercase mb-4 tracking-widest">Nota por Campaña</h3><canvas id="chPie"></canvas></div>
            <div class="grid-card p-8 h-[450px]"><h3 class="text-[11px] font-black uppercase mb-4 tracking-widest">Monitoreos por Analista</h3><canvas id="chAna"></canvas></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="grid-card p-8 h-[500px]"><h3 class="text-[11px] font-black uppercase mb-4 text-red-600 tracking-widest">Críticos por Supervisor</h3><canvas id="chSupCri"></canvas></div>
            <div class="grid-card p-8 h-[500px]"><h3 class="text-[11px] font-black uppercase mb-4 tracking-widest text-red-600">Top 10 Ejecutivos Críticos</h3><canvas id="chTop"></canvas></div>
        </div>

        <div class="grid-card p-8 h-[450px] mb-8">
            <h3 class="text-[11px] font-black uppercase mb-4 tracking-widest">Frecuencia de Errores por Categoría</h3>
            <canvas id="chErr"></canvas>
        </div>

        <div id="tablesContainer" class="space-y-10"></div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        
        const USER_OK = "admin";
        const PASS_OK = "movi2026";
        const CSV_URL = "https://raw.githubusercontent.com/vamp00001/Reporte-QA-GMT-Movistar/main/movi_2.csv";

        let gData = []; let charts = {};
        const catNames = ["Apertura","Profesionalismo","Tono","Lenguaje","Contactación","Habilidades","Resolución","Empatía","Apreciación","Información","Procedimientos","Sistemas","Cierre"];

        window.onload = () => {
            if(localStorage.getItem('gmt_auth') === 'true') {
                document.getElementById('loginOverlay').style.display = 'none';
                cargarDatosAutomaticos();
            }
        };

        function validarAcceso() {
            if(document.getElementById('userInput').value === USER_OK && document.getElementById('passInput').value === PASS_OK) {
                localStorage.setItem('gmt_auth', 'true');
                document.getElementById('loginOverlay').style.display = 'none';
                cargarDatosAutomaticos();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('gmt_auth');
            location.reload();
        }

        function cargarDatosAutomaticos() {
            fetch(CSV_URL)
                .then(res => res.text())
                .then(csvText => {
                    const lines = csvText.split(/\r?\n/).filter(l => l.includes(','));
                    gData = lines.slice(1).map(line => {
                        const p = line.split(',').map(c => c.trim().replace(/"/g, ''));
                        let errArray = [];
                        for(let i=6; i<=18; i++) {
                            let val = (p[i] || "").toUpperCase();
                            errArray.push(val.includes('ERROR') || val.includes('CRITICO') ? 1 : 0);
                        }
                        return {
                            mes: p[0], nota: parseFloat(p[1]) || 0, eje: p[2], sup: p[3], 
                            camp: p[4], sem: p[5], crit: errArray.some(v => v === 1) ? 1 : 0, 
                            errs: errArray, ana: p[19] || "S/A"
                        };
                    });
                    setup(); 
                    update('ALL', 'ALL');
                    document.getElementById('mainContent').classList.remove('hidden');
                })
                .catch(() => alert("Error al conectar con GitHub."));
        }

        function setup() {
            const m = [...new Set(gData.map(d => d.mes))].sort();
            const w = [...new Set(gData.map(d => d.sem))].sort();
            const ms = document.getElementById('mSel'), ws = document.getElementById('wSel');
            ms.innerHTML = '<option value="ALL">MES ACUMULADO</option>';
            ws.innerHTML = '<option value="ALL">SEMANA</option>';
            m.forEach(x => ms.innerHTML += `<option value="${x}">${x}</option>`);
            w.forEach(x => ws.innerHTML += `<option value="${x}">${x}</option>`);
            ms.onchange = ws.onchange = () => update(ms.value, ws.value);
        }

        function update(fM, fW) {
            let d = gData;
            if(fM!=='ALL') d = d.filter(x => x.mes === fM);
            if(fW!=='ALL') d = d.filter(x => x.sem === fW);

            const pos = d.filter(x => x.camp.toUpperCase().includes('POSPAGO'));
            const pre = d.filter(x => x.camp.toUpperCase().includes('PREPAGO'));
            const avg = (a) => a.length ? (a.reduce((s,v)=>s+v.nota,0)/a.length).toFixed(1) : 0;

            document.getElementById('k-pos').innerText = avg(pos) + "%";
            document.getElementById('k-pre').innerText = avg(pre) + "%";
            document.getElementById('k-tot').innerText = avg(d) + "%";
            document.getElementById('k-cas').innerText = d.length;
            document.getElementById('k-cri').innerText = d.reduce((s,v)=>s+v.crit,0);

            renderPie('chPie', {'POSPAGO': avg(pos), 'PREPAGO': avg(pre)});
            
            // Analistas
            const anas = {}; d.forEach(x => anas[x.ana] = (anas[x.ana] || 0) + 1);
            renderBar('chAna', anas, '#019DF4', false, 15, true); 

            // Críticos por Supervisor (Nuevo)
            const supCri = {}; d.filter(x => x.crit > 0).forEach(x => supCri[x.sup] = (supCri[x.sup] || 0) + 1);
            renderBar('chSupCri', supCri, '#991B1B', true, 10);

            // Errores por Categoría
            const eCounts = new Array(13).fill(0);
            d.forEach(x => x.errs.forEach((v,i) => eCounts[i]+=v));
            const eMap = {}; catNames.forEach((n,i) => eMap[n] = eCounts[i]);
            renderBar('chErr', eMap, '#EF4444', false);

            // Top Ejecutivos Críticos
            const ejesCri = {}; d.filter(x => x.crit>0).forEach(x => ejesCri[x.eje] = (ejesCri[x.eje] || 0) + 1);
            renderBar('chTop', ejesCri, '#B91C1C', true, 10);

            // Tablas
            renderTables(d);
        }

        function renderTables(d) {
            const container = document.getElementById('tablesContainer');
            container.innerHTML = ''; 
            const campañas = [...new Set(d.map(x => x.camp))];

            campañas.forEach(camp => {
                const dataCamp = d.filter(x => x.camp === camp);
                const ag = dataCamp.reduce((acc, curr) => {
                    if (!acc[curr.eje]) acc[curr.eje] = { ...curr, notas: [curr.nota], totalCrit: curr.crit, moni: 1, errSet: new Set() };
                    else { acc[curr.eje].notas.push(curr.nota); acc[curr.eje].totalCrit += curr.crit; acc[curr.eje].moni++; }
                    curr.errs.forEach((v, i) => { if(v===1) acc[curr.eje].errSet.add(catNames[i]) });
                    return acc;
                }, {});

                let html = `<div class="grid-card overflow-hidden shadow-xl"><div class="bg-[#001935] p-5 border-l-[12px] border-[#019DF4]"><h2 class="text-white font-black uppercase italic text-sm tracking-widest">${camp}</h2></div><table class="w-full text-[10px] text-left"><thead class="bg-gray-50 border-b italic font-black text-gray-400 uppercase"><tr><th class="p-4">Supervisor</th><th class="p-4">Ejecutivo</th><th class="p-4">Errores</th><th class="p-4 text-center">Nota</th><th class="p-4 text-center">Estado</th></tr></thead><tbody class="divide-y divide-gray-100">`;

                Object.values(ag).sort((a,b) => (b.notas.reduce((s,v)=>s+v,0)/b.notas.length) - (a.notas.reduce((s,v)=>s+v,0)/a.notas.length)).forEach(x => {
                    const prom = (x.notas.reduce((s,v)=>s+v,0)/x.notas.length).toFixed(1);
                    const errTxt = x.errSet.size ? Array.from(x.errSet).join(', ') : 'Ninguno';
                    html += `<tr class="hover:bg-gray-50"><td class="p-4 font-bold text-gray-500">${x.sup}</td><td class="p-4 font-black text-[#001935] uppercase">${x.eje}</td><td class="p-4 text-red-600 font-bold">${errTxt}</td><td class="p-4 text-center font-black text-lg">${prom}%</td><td class="p-4 text-center"><span class="px-3 py-1 rounded-full font-black ${x.totalCrit > 0?'bg-red-100 text-red-600':'bg-green-100 text-green-600'}">${x.totalCrit > 0?'CRITICO':'OK'}</span></td></tr>`;
                });
                container.innerHTML += html + `</tbody></table></div>`;
            });
        }

        function renderPie(id, m) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'pie', data: { labels: Object.keys(m), datasets: [{data: Object.values(m), backgroundColor: ['#001935','#019DF4'], borderWidth: 5, borderColor: '#fff'}]},
                options: { maintainAspectRatio: false, plugins: { datalabels: { color: '#fff', font: { weight: 'black', size: 20 }, formatter: v => v + "%" }, legend: { position: 'top', labels: { font: { weight: 'bold' } } } } }
            });
        }

        function renderBar(id, m, c, h, lim=20, dentro=false) {
    if(charts[id]) charts[id].destroy();
    const keys = Object.keys(m).sort((a,b)=>m[b]-m[a]).slice(0, lim);
    charts[id] = new Chart(document.getElementById(id), {
        type: 'bar', 
        data: { labels: keys, datasets: [{data: keys.map(k=>m[k]), backgroundColor: c, borderRadius: 8}]},
        options: { 
            indexAxis: h?'y':'x', 
            maintainAspectRatio: false, 
            plugins: { 
                legend: {display:false}, 
                datalabels: { 
                    // POSICIÓN: 'end' coloca el número al final de la barra
                    anchor: 'end', 
                    // ALINEACIÓN: 'right' para barras horizontales, 'top' para verticales
                    align: h ? 'right' : 'top', 
                    color: '#444', 
                    // TAMAÑO: Cambia el valor de 'size' para hacer los números más grandes
                    font: {
                        weight: 'black', 
                        size: 16 // <-- Aumenta este número (ej. 18 o 20)
                    },
                    // ESPACIADO: Añade un offset para que no pegue a la barra
                    offset: 4 
                } 
            },
            scales: { 
                y: { grid:{display:false}, ticks:{font:{weight:'bold', size:11}} }, 
                x: { 
                    grid:{display:false}, 
                    // IMPORTANTE: Añade 'suggestedMax' para dar aire al final de la gráfica
                    suggestedMax: Math.max(...Object.values(m)) * 1.2,
                    ticks:{font:{weight:'bold', size:11}} 
                } 
            }
        }
    });
}
    </script>
</body>
</html>

