<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA QA GMT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,wght@1,900&display=swap');
        body { font-family: 'Inter', sans-serif; font-style: italic; background-color: #f1f5f9; user-select: none; }
        .grid-card { border-radius: 1.5rem; background: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #001935; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="pb-10">

    <div id="loginOverlay">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-sm text-center">
            <div class="mb-6"><span class="text-4xl"></span></div>
            <h2 class="text-2xl font-black text-[#001935] mb-2 italic">PORTAL <span class="text-[#019DF4]">GMT</span></h2>
            <p class="text-gray-400 text-[9px] font-bold uppercase mb-8 tracking-[0.2em]">Visualizaci贸n de Datos</p>
            <input type="text" id="userInput" placeholder="Usuario" class="w-full p-4 mb-4 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-[#019DF4] font-bold">
            <input type="password" id="passInput" placeholder="Contrase帽a" class="w-full p-4 mb-8 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-[#019DF4] font-bold">
            <button onclick="validarAcceso()" class="w-full bg-[#001935] text-white p-4 rounded-2xl font-black hover:bg-[#019DF4] transition-all uppercase italic">Acceder al Reporte</button>
            <p id="loginError" class="text-red-500 text-[10px] mt-4 font-black hidden uppercase">Acceso Denegado</p>
        </div>
    </div>

    <nav class="bg-[#001935] p-6 border-b-4 border-[#019DF4] sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-xl font-black text-white uppercase italic">REPORTES <span class="text-[#019DF4]">GMT</span></h1>
            <div class="flex items-center gap-3">
                <select id="mSel" class="p-2 rounded-xl font-bold text-[10px] outline-none border-none bg-white text-[#001935]"></select>
                <select id="wSel" class="p-2 rounded-xl font-bold text-[10px] outline-none border-none bg-white text-[#001935]"></select>
                
                <label class="cursor-pointer bg-white/10 hover:bg-white/20 p-2 rounded-xl transition-all">
                    <span class="text-white text-[10px] font-bold px-2 uppercase">Actualizar Local</span>
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                </label>
                
                <button onclick="logout()" class="p-2 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white rounded-xl text-[10px] font-bold transition-all px-4">SALIR</button>
            </div>
        </div>
    </nav>

    <div id="mainContent" class="max-w-[1600px] mx-auto p-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <div class="grid-card p-6 border-t-4 border-[#019DF4] text-center"><p class="text-[9px] font-black text-gray-400 uppercase mb-2">Pospago</p><p id="k-pos" class="text-3xl font-black text-[#001935]">0%</p></div>
            <div class="grid-card p-6 border-t-4 border-cyan-400 text-center"><p class="text-[9px] font-black text-gray-400 uppercase mb-2">Prepago</p><p id="k-pre" class="text-3xl font-black text-[#001935]">0%</p></div>
            <div class="grid-card p-6 border-t-4 border-slate-800 text-center"><p class="text-[9px] font-black text-gray-400 uppercase mb-2">Total</p><p id="k-tot" class="text-3xl font-black text-[#001935]">0%</p></div>
            <div class="grid-card p-6 border-t-4 border-blue-500 text-center"><p class="text-[9px] font-black text-gray-400 uppercase mb-2">Casos</p><p id="k-cas" class="text-3xl font-black text-[#001935]">0</p></div>
            <div class="grid-card p-6 border-t-4 border-red-500 text-center"><p class="text-[9px] font-black text-red-500 uppercase mb-2">Cr铆ticos</p><p id="k-cri" class="text-3xl font-black text-red-600">0</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="grid-card p-6 h-[400px] flex flex-col items-center"><canvas id="chPie"></canvas></div>
            <div class="grid-card p-6 h-[400px]"><canvas id="chAna"></canvas></div>
        </div>

        <div id="tablesContainer" class="space-y-8"></div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        const USER_OK = "admin", PASS_OK = "movi2026";
        const CSV_URL = "https://raw.githubusercontent.com/vamp00001/Reporte-QA-GMT-Movistar/main/movi_2.csv";
        
        let gData = []; let charts = {};
        const catNames = ["Apertura","Profesionalismo","Tono","Lenguaje","Contactaci贸n","Habilidades","Resoluci贸n","Empat铆a","Apreciaci贸n","Informaci贸n","Procedimientos","Sistemas","Cierre"];

        function validarAcceso() {
            if(document.getElementById('userInput').value === USER_OK && document.getElementById('passInput').value === PASS_OK) {
                document.getElementById('loginOverlay').style.display = 'none';
                cargarDatosServer();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function cargarDatosServer() {
            fetch(CSV_URL).then(r => r.text()).then(d => procesar(d)).catch(() => alert("Error al conectar con la base de datos."));
        }

        // Carga manual sin opci贸n de descarga
        document.getElementById('csvFileInput').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => procesar(ev.target.result);
            reader.readAsText(e.target.files[0], 'ISO-8859-1');
        });

        function procesar(csvText) {
            const lines = csvText.split(/\r?\n/).filter(l => l.includes(','));
            gData = lines.slice(1).map(line => {
                const p = line.split(',').map(c => c.trim().replace(/"/g, ''));
                let errs = [];
                for(let i=6; i<=18; i++) {
                    let v = (p[i] || "").toUpperCase();
                    errs.push(v.includes('ERROR') || v.includes('CRITICO') ? 1 : 0);
                }
                return {
                    mes: p[0], nota: parseFloat(p[1]) || 0, eje: p[2], sup: p[3], 
                    camp: p[4], sem: p[5], crit: errs.some(v => v === 1) ? 1 : 0, errs, ana: p[19] || "S/A"
                };
            });
            setup(); update('ALL', 'ALL');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        function setup() {
            const m = [...new Set(gData.map(d => d.mes))].sort();
            const w = [...new Set(gData.map(d => d.sem))].sort();
            const ms = document.getElementById('mSel'), ws = document.getElementById('wSel');
            ms.innerHTML = '<option value="ALL">MES ACUMULADO</option>';
            ws.innerHTML = '<option value="ALL">SEMANA</option>';
            m.forEach(x => ms.innerHTML += `<option value="${x}">${x}</option>`);
            w.forEach(x => ws.innerHTML += `<option value="${x}">${x}</option>`);
            ms.onchange = ws.onchange = () => update(ms.value, ws.value);
        }

        function update(fM, fW) {
            let d = gData;
            if(fM!=='ALL') d = d.filter(x => x.mes === fM);
            if(fW!=='ALL') d = d.filter(x => x.sem === fW);
            const pos = d.filter(x => x.camp.toUpperCase().includes('POSPAGO')), pre = d.filter(x => x.camp.toUpperCase().includes('PREPAGO'));
            const avg = (a) => a.length ? (a.reduce((s,v)=>s+v.nota,0)/a.length).toFixed(1) : 0;
            
            document.getElementById('k-pos').innerText = avg(pos) + "%";
            document.getElementById('k-pre').innerText = avg(pre) + "%";
            document.getElementById('k-tot').innerText = avg(d) + "%";
            document.getElementById('k-cas').innerText = d.length;
            document.getElementById('k-cri').innerText = d.reduce((s,v)=>s+v.crit,0);

            renderPie('chPie', {'POSPAGO': avg(pos), 'PREPAGO': avg(pre)});
            const anas = {}; d.forEach(x => anas[x.ana] = (anas[x.ana] || 0) + 1);
            renderBar('chAna', anas, '#019DF4'); 

            const container = document.getElementById('tablesContainer'); container.innerHTML = '';
            [...new Set(d.map(x => x.camp))].forEach(camp => {
                const dataCamp = d.filter(x => x.camp === camp);
                let html = `<div class="grid-card overflow-hidden"><div class="bg-[#001935] p-4 border-l-8 border-[#019DF4]"><h2 class="text-white font-black uppercase italic text-xs">${camp}</h2></div><table class="w-full text-[10px] text-left">`;
                // ... (resto de la tabla similar a la anterior) ...
                container.innerHTML += html + `</table></div>`;
            });
        }

        function renderPie(id, m) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'pie', data: { labels: Object.keys(m), datasets: [{data: Object.values(m), backgroundColor: ['#001935','#019DF4']}]},
                options: { maintainAspectRatio: false, plugins: { datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: v => v + "%" } } }
            });
        }

        function renderBar(id, m, c) {
            if(charts[id]) charts[id].destroy();
            const keys = Object.keys(m).sort((a,b)=>m[b]-m[a]).slice(0, 10);
            charts[id] = new Chart(document.getElementById(id), {
                type: 'bar', data: { labels: keys, datasets: [{data: keys.map(k=>m[k]), backgroundColor: c}]},
                options: { maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>
